{"version":3,"sources":["assets\\Script\\Backpack\\UI_BackPackScrollView.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import Global from \"../App/Global\";\r\nimport { LocMsg } from \"../BaseModel/MsgEvent\";\r\nimport { DataBaseKey } from \"../BaseModel/Types\";\r\nimport DataManager from \"../Manager/DataManager\";\r\nimport { IPlayerInfo } from \"../Model/PlayerProp\";\r\nimport { IRobot } from \"../Model/RobotProp\";\r\nimport BackpackItem from \"./BackpackItem\";\r\n\r\n\r\n\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n@ccclass\r\nexport default class UI_BackPackScrollView extends cc.ScrollView {\r\n    @property(cc.Prefab)\r\n    itemPrefab: cc.Prefab = null;\r\n    @property(cc.Layout)\r\n    lytContent: cc.Layout = null;\r\n    @property(cc.Node)\r\n    maskNode: cc.Node = null;\r\n    @property({ displayName: '每行个数' })\r\n    colCount: number = 3;\r\n\r\n    private _itemPools: BackpackItem[] = [];\r\n    private _cacheData: { idx: number, roomTypeData: IRobot, poolIdx: number, height: number }[] = [];\r\n\r\n    private _inited = false;\r\n    private _totalHeight = 0;\r\n    private _itemCount = 0;\r\n\r\n    onLoad() {\r\n        // this.content.parent.parent.getComponent(cc.Widget).updateAlignment();\r\n        this.content.parent.getComponent(cc.Widget).updateAlignment();\r\n        this._InitPoolSize();\r\n        this._itemPools = [];\r\n        this.content.destroyAllChildren();\r\n\r\n        let initItemGenerator = this._GetItemGenerator();\r\n        let cb = () => {\r\n            let it = initItemGenerator.next();\r\n            if (it.done) {\r\n                this.unschedule(cb);\r\n            }\r\n        };\r\n        this.schedule(cb, 1 / cc.game.getFrameRate());\r\n\r\n        Global.Inst.On(LocMsg.UPDATE_BACK_PACK_DATA, this._FreashData, this);\r\n    }\r\n\r\n    protected onEnable(): void {\r\n        super.onEnable();\r\n        // let testData: IRobot[] = [];\r\n        // for (let index = 0; index < 20; index++) {\r\n        //     let data: IRobot = {\r\n        //         id: index,\r\n        //         robotImgId: index % RobotTypeCount,\r\n        //         mint: index,\r\n        //         level: index,\r\n        //         robotType: index % RobotTypeCount,\r\n        //         efficiency: Math.ceil(Math.random() * 10) / 10,\r\n        //         luck: Math.ceil(Math.random() * 10) / 10,\r\n        //         loss: Math.ceil(Math.random() * 10) / 10,\r\n        //         sol: 0\r\n        //     }\r\n        //     testData.push(data)\r\n\r\n        // }\r\n\r\n        let robotList = DataManager.Inst.GetData<IPlayerInfo>(DataBaseKey.PLAYER_DATA).robotList;\r\n        this.SetData(robotList);\r\n    }\r\n    private _FreashData(gameTypeCreatDatas: IRobot[]) {\r\n        this.SetData(gameTypeCreatDatas)\r\n    }\r\n\r\n    SetData(gameTypeCreatDatas: IRobot[]) {\r\n\r\n        this._cacheData = [];\r\n        this._totalHeight = 0;\r\n\r\n        //AppLog.Log('-- itemCount: ', this._itemCount);\r\n\r\n        for (let i = 0, poolIdx = 0; i < gameTypeCreatDatas.length; ++i, ++poolIdx) {\r\n            if (poolIdx >= this._itemCount) poolIdx = 0;\r\n            let h = this.itemPrefab.data.height;\r\n            this._cacheData.push({\r\n                idx: i,\r\n                roomTypeData: gameTypeCreatDatas[i],\r\n                poolIdx: poolIdx,\r\n                height: h,\r\n            });\r\n        }\r\n\r\n        let col = Math.ceil(this._cacheData.length / this.colCount);\r\n        let padding = this.lytContent.paddingTop + this.lytContent.paddingBottom;\r\n        this._totalHeight = col * this.itemPrefab.data.height + (col - 1) * this.lytContent.spacingY + padding;\r\n        this.content.height = this.elastic ? Math.max(this._totalHeight, this.content.parent.height) : this._totalHeight;\r\n\r\n        if (this._inited) this.OnScrolling(this, null);\r\n    }\r\n\r\n    OnScrolling(event: cc.ScrollView, customEventData: string) {\r\n        if (!this._inited) return;\r\n        if (!this.itemPrefab.data) return;\r\n\r\n        let offsetY = event.getScrollOffset().y;\r\n        let res = this._CalculateStartAndEndIdx(offsetY);\r\n        for (let i = res.startRow; i <= res.endRow; ++i) {\r\n            for (let j = 0; j < this.colCount; ++j) {\r\n                this._ProcessScrollViewItem(i * this.colCount + j);\r\n            }\r\n        }\r\n    }\r\n\r\n    private _CalculateStartAndEndIdx(offsetY: number): { startRow: number; endRow: number } {\r\n\r\n        let itemHeight = this.itemPrefab.data.height + this.lytContent.spacingY;\r\n\r\n        let startRow = Math.floor((offsetY + this.lytContent.paddingTop) / itemHeight);\r\n        // if (startRow > 0) --startRow;\r\n\r\n        let maxRow = Math.ceil(this._itemCount / this.colCount) - 1;\r\n        let maxDataCount = Math.ceil(this._cacheData.length / this.colCount);\r\n\r\n        let endRow = startRow + maxRow;\r\n        if (endRow >= maxDataCount) {\r\n            endRow = maxDataCount - 1;\r\n        }\r\n        return {\r\n            startRow: startRow,\r\n            endRow: endRow,\r\n        };\r\n    }\r\n\r\n    private _ProcessScrollViewItem(idx: number) {\r\n        let data = this._cacheData[idx];\r\n        if (!data) return;\r\n        let item = this._itemPools[data.poolIdx];\r\n        // if (!item || (item && item.renderIdx == idx && item.robotId == data.roomTypeData.id)) return;\r\n        if (!item) return;\r\n        item.node.name = idx.toString();\r\n        item.SetItem(idx, data.roomTypeData);\r\n        item.node.active = true;\r\n        item.node.setPosition(this._CalculateItemPos(idx));\r\n    }\r\n\r\n    private _CalculateItemPos(idx) {\r\n        let row = Math.floor(idx / this.colCount);\r\n        let offsetY = row * (this.itemPrefab.data.height + this.lytContent.spacingY) + this.itemPrefab.data.height / 2;\r\n        //posX\r\n        let xStart = -this.lytContent.node.width / 2 + this.lytContent.paddingLeft;\r\n        let col = idx - row * this.colCount;\r\n        let x = xStart + col * (this.itemPrefab.data.width + this.lytContent.spacingX) + this.itemPrefab.data.width / 2;\r\n        return cc.v2(x, -offsetY);\r\n    }\r\n\r\n    private *_GetItemGenerator() {\r\n        for (let index = 0; index < this._itemCount; index++) {\r\n            let node = cc.instantiate(this.itemPrefab);\r\n            node.active = false;\r\n            this.content.addChild(node);\r\n            let comp = node.getComponent(BackpackItem);\r\n            this._itemPools.push(comp);\r\n            yield;\r\n        }\r\n        this._inited = true;\r\n        this.OnScrolling(this, null);\r\n    }\r\n\r\n    private _InitPoolSize() {\r\n        let item_w = this.itemPrefab.data.width;\r\n        let item_h = this.itemPrefab.data.height;\r\n        let colCount = this.colCount;\r\n        let rowCount = Math.abs(Math.ceil(this.content.parent.height / (item_h + this.lytContent.spacingY)));\r\n        this._itemCount = colCount * (rowCount + 1);\r\n    }\r\n}\r\n"]}